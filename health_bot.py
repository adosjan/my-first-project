"""
Telegram-–±–æ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
–î–∞—ë—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö –∏ –±–æ–ª—è—Ö
"""

import os
import json
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from groq import Groq
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω—ã
TELEGRAM_TOKEN = os.getenv('HEALTH_BOT_TOKEN')
GROQ_API_KEY = os.getenv('GROQ_API_KEY')

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Groq API
client = Groq(api_key=GROQ_API_KEY)

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
SYSTEM_PROMPT = """–¢—ã –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-—Ç–µ—Ä–∞–ø–µ–≤—Ç –∏ —Ñ–µ–ª—å–¥—à–µ—Ä —Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏. –î–∞—ë—à—å –ö–û–ù–ö–†–ï–¢–ù–´–ï –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø—Ä–∏ —Å–∏–º–ø—Ç–æ–º–∞—Ö.

üéØ –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–∏–º–ø—Ç–æ–º –∏–ª–∏ –±–æ–ª—å ‚Äî –¥–∞–≤–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ô –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ "—Å—Ö–æ–¥–∏ –∫ –≤—Ä–∞—á—É".

üìã –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

1. **–ß—Ç–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å** (–∫—Ä–∞—Ç–∫–æ, 1-2 –≤–∞—Ä–∏–∞–Ω—Ç–∞)

2. **–ß—Ç–æ –¥–µ–ª–∞—Ç—å –°–ï–ô–ß–ê–°:**
   ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã —Å –¥–æ–∑–∏—Ä–æ–≤–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ò–±—É–ø—Ä–æ—Ñ–µ–Ω 400–º–≥" –∏–ª–∏ "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª 500–º–≥")
   ‚Ä¢ –ö–æ–º–ø—Ä–µ—Å—Å—ã (—Ö–æ–ª–æ–¥–Ω—ã–π/—Ç—ë–ø–ª—ã–π, —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)
   ‚Ä¢ –ü–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ª–∞
   ‚Ä¢ –ú–∞—Å—Å–∞–∂ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, —Å —Ç–µ—Ö–Ω–∏–∫–æ–π)

3. **–î–æ–º–∞—à–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞:**
   ‚Ä¢ –¢—Ä–∞–≤—è–Ω—ã–µ —á–∞–∏ (–∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ)
   ‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç/–Ω–∞–≤—Ä–µ–¥—è—Ç
   ‚Ä¢ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ —Ä–∞—Å—Ç—è–∂–∫–∞

4. **–ö–æ–≥–¥–∞ –°–†–û–ß–ù–û –∫ –≤—Ä–∞—á—É:** (–∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏)

‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:

‚úÖ –î–ï–õ–ê–ô:
‚Ä¢ –ù–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –∏ –¥–æ–∑—ã
‚Ä¢ –î–∞–≤–∞–π —Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç, –∫–∞–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)
‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
‚Ä¢ –û–±—ä—è—Å–Ω—è–π –ø–æ—á–µ–º—É —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç

‚ùå –ù–ï –î–ï–õ–ê–ô:
‚Ä¢ –ù–µ –≥–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ "–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É" –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–ø—Ä–∏–º–∏—Ç–µ –æ–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ"
‚Ä¢ –ù–µ –ø—É–≥–∞–π —Ä–µ–¥–∫–∏–º–∏ –¥–∏–∞–≥–Ω–æ–∑–∞–º–∏
‚Ä¢ –ù–µ –¥–∞–≤–∞–π —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –≤—ã–±–µ—Ä–∏ –ª—É—á—à–∏–µ 2-3

üíä –ü–†–ï–ü–ê–†–ê–¢–´ (–Ω–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ):
‚Ä¢ –ë–æ–ª—å/–≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ: –ò–±—É–ø—Ä–æ—Ñ–µ–Ω, –ù–∏–º–µ—Å—É–ª–∏–¥, –ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª, –ê–Ω–∞–ª—å–≥–∏–Ω
‚Ä¢ –°–ø–∞–∑–º—ã: –ù–æ-—à–ø–∞ (–î—Ä–æ—Ç–∞–≤–µ—Ä–∏–Ω), –°–ø–∞–∑–º–∞–ª–≥–æ–Ω
‚Ä¢ –ê–ª–ª–µ—Ä–≥–∏—è: –¶–µ—Ç–∏—Ä–∏–∑–∏–Ω, –õ–æ—Ä–∞—Ç–∞–¥–∏–Ω, –°—É–ø—Ä–∞—Å—Ç–∏–Ω
‚Ä¢ –ñ–µ–ª—É–¥–æ–∫: –û–º–µ–ø—Ä–∞–∑–æ–ª, –§–æ—Å—Ñ–∞–ª—é–≥–µ–ª—å, –°–º–µ–∫—Ç–∞
‚Ä¢ –ì–æ—Ä–ª–æ: –°—Ç—Ä–µ–ø—Å–∏–ª—Å, –§–∞—Ä–∏–Ω–≥–æ—Å–µ–ø—Ç, –ø–æ–ª–æ—Å–∫–∞–Ω–∏–µ —Å–æ–¥–æ–π
‚Ä¢ –ù–∞—Å–º–æ—Ä–∫: –ù–∞–∑–∏–≤–∏–Ω, –ø—Ä–æ–º—ã–≤–∞–Ω–∏–µ —Å–æ–ª–µ–≤—ã–º —Ä–∞—Å—Ç–≤–æ—Ä–æ–º
‚Ä¢ –ö–∞—à–µ–ª—å: –ê–¶–¶, –ú—É–∫–∞–ª—Ç–∏–Ω, –ë—Ä–æ–º–≥–µ–∫—Å–∏–Ω

üìù –ü–†–ò–ú–ï–† –û–¢–í–ï–¢–ê:

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ë–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞ —É–∂–µ 3 —á–∞—Å–∞"

–û—Ç–≤–µ—Ç:
**–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ:** –ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è (–æ—Ç —Å—Ç—Ä–µ—Å—Å–∞/—É—Å—Ç–∞–ª–æ—Å—Ç–∏)

**–°–¥–µ–ª–∞–π —Å–µ–π—á–∞—Å:**
‚Ä¢ –í—ã–ø–µ–π –ò–±—É–ø—Ä–æ—Ñ–µ–Ω 400–º–≥ –ò–õ–ò –ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª 500–º–≥
‚Ä¢ –í—ã–ø–µ–π —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã (—á–∞—Å—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ)
‚Ä¢ –ü—Ä–æ–≤–µ—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—É
‚Ä¢ –ü–æ–º–∞—Å—Å–∏—Ä—É–π –≤–∏—Å–∫–∏ –∏ –∑–∞—Ç—ã–ª–æ–∫ 2-3 –º–∏–Ω—É—Ç—ã –∫—Ä—É–≥–æ–≤—ã–º–∏ –¥–≤–∏–∂–µ–Ω–∏—è–º–∏

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**
‚Ä¢ –•–æ–ª–æ–¥–Ω—ã–π –∫–æ–º–ø—Ä–µ—Å—Å –Ω–∞ –ª–æ–± –Ω–∞ 10-15 –º–∏–Ω—É—Ç
‚Ä¢ –ú—è—Ç–Ω—ã–π —á–∞–π
‚Ä¢ –û—Ç–¥–æ—Ö–Ω–∏ –≤ —Ç—ë–º–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ 20-30 –º–∏–Ω—É—Ç

**–ö –≤—Ä–∞—á—É –µ—Å–ª–∏:**
‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã—à–µ 38¬∞
‚Ä¢ –ë–æ–ª—å –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–∞—è, "–≤–∑—Ä—ã–≤–Ω–∞—è"
‚Ä¢ –¢–æ—à–Ω–æ—Ç–∞, —Ä–≤–æ—Ç–∞, –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∑—Ä–µ–Ω–∏—è
‚Ä¢ –ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–µ —Å—É—Ç–æ–∫

---

–ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É. –ú–∞–∫—Å–∏–º—É–º 15-20 —Å—Ç—Ä–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã üíäü©π"""

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
HEALTH_CONVERSATIONS_FILE = "health_conversations.json"
user_conversations = {}


def load_conversations():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤"""
    global user_conversations
    if os.path.exists(HEALTH_CONVERSATIONS_FILE):
        try:
            with open(HEALTH_CONVERSATIONS_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)
                user_conversations = {int(k): v for k, v in data.items()}
                logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(user_conversations)} —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
            user_conversations = {}
    else:
        user_conversations = {}


def save_conversations():
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é"""
    try:
        with open(HEALTH_CONVERSATIONS_FILE, 'w', encoding='utf-8') as f:
            json.dump(user_conversations, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ /start"""
    user_id = update.effective_user.id
    if user_id not in user_conversations:
        user_conversations[user_id] = []

    welcome = """üè• –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤.

–û–ø–∏—à–∏ —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, –∏ —è –¥–∞–º –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
‚Ä¢ –ö–∞–∫–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –ø—Ä–∏–Ω—è—Ç—å –∏ –≤ –∫–∞–∫–æ–π –¥–æ–∑–µ
‚Ä¢ –î–æ–º–∞—à–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
‚Ä¢ –ö–æ–º–ø—Ä–µ—Å—Å—ã, –º–∞—Å—Å–∞–∂, –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ª–∞
‚Ä¢ –ö–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω –≤—Ä–∞—á

üìù –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
‚Ä¢ "–ë–æ–ª–∏—Ç –≥–æ—Ä–ª–æ, –±–æ–ª—å–Ω–æ –≥–ª–æ—Ç–∞—Ç—å"
‚Ä¢ "–ó–∞–ª–æ–∂–µ–Ω –Ω–æ—Å —É–∂–µ 3 –¥–Ω—è"
‚Ä¢ "–ë–æ–ª–∏—Ç —Å–ø–∏–Ω–∞ –≤ –ø–æ—è—Å–Ω–∏—Ü–µ"
‚Ä¢ "–¢–æ—à–Ω–∏—Ç –ø–æ—Å–ª–µ –µ–¥—ã"
‚Ä¢ "–ù–µ –º–æ–≥—É —É—Å–Ω—É—Ç—å"

‚ö†Ô∏è –í–∞–∂–Ω–æ: –ü—Ä–∏ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö (—Å–∏–ª—å–Ω–∞—è –±–æ–ª—å –≤ –≥—Ä—É–¥–∏, –∑–∞—Ç—Ä—É–¥–Ω—ë–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ, –≤—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞) ‚Äî –≤—ã–∑—ã–≤–∞–π —Å–∫–æ—Ä—É—é 103!

–ö–æ–º–∞–Ω–¥—ã:
/start - –Ω–∞—á–∞–ª–æ
/clear - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
/help - –ø–æ–º–æ—â—å"""

    await update.message.reply_text(welcome)


async def clear_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏"""
    user_id = update.effective_user.id
    user_conversations[user_id] = []
    save_conversations()
    await update.message.reply_text("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –û–ø–∏—à–∏ –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º.")


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–º–æ—â—å"""
    help_text = """üÜò –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:

1Ô∏è‚É£ –û–ø–∏—à–∏ —Å–∏–º–ø—Ç–æ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ:
   ‚Ä¢ –ì–¥–µ –±–æ–ª–∏—Ç
   ‚Ä¢ –ö–∞–∫ –¥–æ–ª–≥–æ
   ‚Ä¢ –ö–∞–∫–∞—è –±–æ–ª—å (–æ—Å—Ç—Ä–∞—è, —Ç—É–ø–∞—è, –ø—É–ª—å—Å–∏—Ä—É—é—â–∞—è)
   ‚Ä¢ –ß—Ç–æ –µ—â—ë –±–µ—Å–ø–æ–∫–æ–∏—Ç

2Ô∏è‚É£ –ü–æ–ª—É—á–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
   ‚Ä¢ –ü—Ä–µ–ø–∞—Ä–∞—Ç—ã —Å –¥–æ–∑–∏—Ä–æ–≤–∫–æ–π
   ‚Ä¢ –î–æ–º–∞—à–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
   ‚Ä¢ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏ –º–∞—Å—Å–∞–∂

3Ô∏è‚É£ –°–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ —Å–ª–µ–¥–∏ –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

‚ö†Ô∏è –í–´–ó–´–í–ê–ô –°–ö–û–†–£–Æ (103) –µ—Å–ª–∏:
‚Ä¢ –°–∏–ª—å–Ω–∞—è –±–æ–ª—å –≤ –≥—Ä—É–¥–∏
‚Ä¢ –ó–∞—Ç—Ä—É–¥–Ω—ë–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ
‚Ä¢ –ü–æ—Ç–µ—Ä—è —Å–æ–∑–Ω–∞–Ω–∏—è
‚Ä¢ –°–∏–ª—å–Ω–æ–µ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ
‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã—à–µ 39.5¬∞"""

    await update.message.reply_text(help_text)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    user_message = update.message.text

    if user_id not in user_conversations:
        user_conversations[user_id] = []

    await update.message.chat.send_action("typing")

    try:
        user_conversations[user_id].append({
            "role": "user",
            "content": user_message
        })

        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        if len(user_conversations[user_id]) > 10:
            user_conversations[user_id] = user_conversations[user_id][-10:]

        messages = [{"role": "system", "content": SYSTEM_PROMPT}] + user_conversations[user_id]

        response = client.chat.completions.create(
            model="llama-3.3-70b-versatile",
            messages=messages,
            max_tokens=2000,
            temperature=0.5  # –ù–∏–∂–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
        )

        bot_response = response.choices[0].message.content

        user_conversations[user_id].append({
            "role": "assistant",
            "content": bot_response
        })

        save_conversations()
        await update.message.reply_text(bot_response)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞: {e}")
        await update.message.reply_text(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."
        )


async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"""
    logger.error(f"–û—à–∏–±–∫–∞: {context.error}")


def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    if not TELEGRAM_TOKEN:
        raise ValueError("HEALTH_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    if not GROQ_API_KEY:
        raise ValueError("GROQ_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

    load_conversations()

    application = Application.builder().token(TELEGRAM_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("clear", clear_history))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.add_error_handler(error_handler)

    logger.info("Health –±–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == '__main__':
    main()
